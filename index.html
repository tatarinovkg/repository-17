<!doctype html>
<html lang="ru" class="h-full">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <meta name="format-detection" content="telephone=no" />
    <title>All services</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { brand: { DEFAULT: '#5B7CFA', 600: '#4B68D9', 700: '#3E57B8' } },
                    boxShadow: { soft: '0 8px 24px -10px rgb(0 0 0 / 0.18)' }
                }
            }
        }
    </script>
    <style>
        :root { /* –¥–µ—Ñ–æ–ª—Ç—ã, —á—Ç–æ–±—ã IDE –Ω–µ —Ä—É–≥–∞–ª—Å—è –Ω–∞ custom properties */
            color-scheme: light dark;
            --app-bg: #ffffff; --app-fg: #0f172a;
            --sd-from: #f8fafc; --sd-to: #e0e7ff; --sd-fg: #475569;
            --dd-bg: #ffffff;
        }
        .dark :root { --app-bg:#0b1220; --app-fg:#e5e7eb; --sd-from:#0b1220; --sd-to:#1e263b; --sd-fg:#cbd5e1; --dd-bg:#0f172a; }
        html, body { height: 100%;}
        html { -webkit-text-size-adjust: 100%; touch-action: manipulation; }
        body { background: var(--app-bg); color: var(--app-fg); overscroll-behavior: none; min-height: 100dvh; }
        input, select, textarea { font-size: 16px; }
        .animate-in { animation: fadeSlideUp .22s ease-out both; }
        @keyframes fadeSlideUp { from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)} }
        .line-clamp-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
        .break-anywhere { overflow-wrap:anywhere; word-break:break-word; }
    </style>
</head>
<body class="h-full bg-white text-slate-900 dark:bg-slate-900 dark:text-slate-100">
<div id="app" class="min-h-full flex flex-col">
    <!-- App bar -->
    <header class="sticky top-0 z-40 bg-white/85 dark:bg-slate-900/85 backdrop-blur border-b border-slate-200/80 dark:border-slate-800/80">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 h-14 flex items-center gap-3">
            <button id="navBack"
                    class="hidden inline-flex px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800"
                    aria-label="–ù–∞–∑–∞–¥">–ù–∞–∑–∞–¥</button>
            <h1 id="appTitle" class="text-xl font-bold text-brand tracking-tight">–£—Å–ª—É–≥–∏</h1>
            <div class="ml-auto flex items-center gap-2">
                <button id="openSearch" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" title="–ü–æ–∏—Å–∫">üîé</button>
                <button id="themeToggle" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" aria-label="–¢–µ–º–∞"><span id="themeIcon">üåô</span></button>
            </div>
        </div>
    </header>

    <!-- Main container -->
    <main id="screen" class="mx-auto max-w-7xl w-full px-4 sm:px-6 lg:px-8 py-4 flex-1"></main>

    <div style="height: env(safe-area-inset-bottom);"></div>
</div>

<script>
    // ============ Telegram init ============
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    const apiBaseUrl = 'https://bot.ovimex72.ru/api/';

    function initTelegramApp(){
        if (!tg) return;
        try{
            tg.ready(); tg.expand();
            applyTelegramTheme();
            tg.onEvent('themeChanged', applyTelegramTheme);
            tg.MainButton.setParams({ text: '–ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', is_visible: true });
            tg.MainButton.onClick(()=> tg.close());
        }catch(e){ console.warn('TG init error', e); }
    }
    function applyTelegramTheme(){
        if (!tg) return;
        const isDark = tg.colorScheme === 'dark';
        document.documentElement.classList.toggle('dark', isDark);
        const tp = tg.themeParams || {}; const css = document.documentElement.style;
        if (tp.bg_color) css.setProperty('--app-bg', tp.bg_color);
        if (tp.text_color) css.setProperty('--app-fg', tp.text_color);
        if (tp.secondary_bg_color) css.setProperty('--dd-bg', tp.secondary_bg_color);
        updateThemeIcon();
    }
    function haptic(type='impact', style='light'){
        try{ if(!tg?.HapticFeedback) return; if(type==='impact') tg.HapticFeedback.impactOccurred(style); if(type==='success') tg.HapticFeedback.notificationOccurred('success'); if(type==='error') tg.HapticFeedback.notificationOccurred('error'); }catch{}
    }

    // ============ State ============
    let groupsCache=null, groupsLoading=null; // –≥—Ä—É–∑–∏–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—Ö–æ–¥–µ –Ω–∞ root
    const servicesCache=new Map(); // per group
    const serviceDetailsCache=new Map();
    const feedbacksCache=new Map();

    // ============ Boot ============
    document.addEventListener('DOMContentLoaded', () => {
        fastThemeBoot(); initTelegramApp();
        bindHeader();
        window.addEventListener('hashchange', routeFromHash);
        routeFromEntry();
    });
    function fastThemeBoot(){
        try{ const saved=localStorage.getItem('theme'); const isDark=saved? saved==='dark' : window.matchMedia('(prefers-color-scheme: dark)').matches; document.documentElement.classList.toggle('dark', isDark);}catch{}
    }
    function bindHeader(){
        document.getElementById('openSearch').onclick = ()=> { updateHash({ view: 'search', q: '' }); };
        document.getElementById('themeToggle').onclick = ()=> { toggleTheme(); haptic('impact'); };
        document.getElementById('navBack').onclick = ()=> history.back();
    }
    function updateThemeIcon(){ const isDark=document.documentElement.classList.contains('dark'); document.getElementById('themeIcon').textContent = isDark? '‚òÄÔ∏è':'üåô'; }
    function toggleTheme(){ const isDark=!document.documentElement.classList.contains('dark'); document.documentElement.classList.toggle('dark', isDark); localStorage.setItem('theme', isDark?'dark':'light'); updateThemeIcon(); }

    // ============ Router ============
    function routeFromEntry(){
        const sp=new URLSearchParams(location.search); const sid=sp.get('serviceId');
        if(sid && /^\d+$/.test(sid)) { showServiceScreen(Number(sid)); return; }
        // TG start_param
        try{ const startParam=tg?.initDataUnsafe?.start_param; const m=startParam?.match(/(\d{2,})/); if(m){ showServiceScreen(Number(m[1])); return; } }catch{}
        routeFromHash();
    }
    function routeFromHash(){
        const p=new URLSearchParams(location.hash.replace(/^#/,''));
        const view=p.get('view')||'groups';
        const groupId=p.get('group')||null;
        const serviceId=p.get('service')||null;
        const q=p.get('q')||'';

        if(view==='search') { showSearchScreen(q); return; }
        if(serviceId) { showServiceScreen(serviceId); return; }
        if(groupId) { showGroupScreen(groupId); return; }
        showGroupsScreen();
    }
    function updateHash(partial, replace=false){
        const p=new URLSearchParams(location.hash.replace(/^#/,''));
        Object.entries(partial).forEach(([k,v])=>{ if(v===undefined||v===null||v==='') p.delete(k); else p.set(k,v); });
        const next='#'+p.toString(); if(replace) { if(location.hash!==next) history.replaceState(null,'',next); } else { if(location.hash!==next) location.hash=next; }
    }

    // ============ Screens ============
    const screen = () => document.getElementById('screen');
    function setTitle(text){ document.getElementById('appTitle').textContent = text || '–£—Å–ª—É–≥–∏'; }
    function setBackVisible(v){
        const btn = document.getElementById('navBack');
        if (!btn) return;
        if (v) {
            btn.classList.remove('hidden');
            btn.style.display = 'inline-flex';
            try { tg?.BackButton.show(); } catch {}
        } else {
            btn.classList.add('hidden');
            btn.style.display = 'none';
            try { tg?.BackButton.hide(); } catch {}
        }
    }


    // Root: Groups
    async function showGroupsScreen(){
        setBackVisible(false); setTitle('–£—Å–ª—É–≥–∏');
        if(!groupsCache){ screen().innerHTML = pageLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø...'); await fetchGroups(); }
        renderGroups(groupsCache||[]);
    }
    async function fetchGroups(){
        if(groupsCache || groupsLoading) { await groupsLoading; return groupsCache; }
        groupsLoading = (async()=>{
            try{
                const r = await fetch(apiBaseUrl + 'groups', { method:'POST', headers:{'Content-Type':'application/json'} });
                if(!r.ok) throw new Error('Bad response'); groupsCache = await r.json();
            }catch(e){ screen().innerHTML = pageError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä—É–ø–ø—ã.'); console.error(e); }
            finally{ groupsLoading=null; }
        })();
        await groupsLoading; return groupsCache;
    }
    function renderGroups(groups){
        if(!groups?.length){ screen().innerHTML = emptyState('–ì—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã','–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'); return; }
        const wrapper=document.createElement('div'); wrapper.className='grid gap-4 grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4';
        groups.forEach(g=>{
            const gid=getGroupId(g), name=getGroupName(g);
            const card=document.createElement('button'); card.className='text-left rounded-xl border border-slate-200 dark:border-slate-800 p-4 bg-white dark:bg-slate-900 hover:shadow-soft transition animate-in';
            card.innerHTML=`<div class="text-lg font-semibold text-brand mb-1 break-anywhere">${escapeHTML(name)}</div>
                      <div class="text-sm text-slate-500">–û—Ç–∫—Ä—ã—Ç—å –≥—Ä—É–ø–ø—É</div>`;
            card.onclick=()=>{ updateHash({ view:'group', group: gid }); haptic('impact'); };
            wrapper.appendChild(card);
        });
        screen().innerHTML=''; screen().appendChild(wrapper);
    }

    // Group screen
    async function showGroupScreen(groupId){
        setBackVisible(true);
        setTitle('–ì—Ä—É–ø–ø–∞');

        // –°–±—Ä–æ—Å–∏—Ç—å ¬´–ù–∞–∑–∞–¥¬ª –∫ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é (–≤–∞–∂–Ω–æ –ø–æ—Å–ª–µ —ç–∫—Ä–∞–Ω–∞ –ø–æ–∏—Å–∫–∞)
        const backBtn = document.getElementById('navBack');
        if (backBtn) backBtn.onclick = () => history.back();
        try {
            tg?.BackButton?.show();
            tg?.BackButton?.onClick(() => history.back());
        } catch {}

        screen().innerHTML = pageLoading('–ó–∞–≥—Ä—É–∑–∫–∞ —É—Å–ª—É–≥.');
        const services = await fetchServices(groupId);
        renderServices(services, groupId);
    }

    async function fetchServices(groupId){
        if(servicesCache.has(groupId)) return servicesCache.get(groupId);
        try{
            const r = await fetch(`${apiBaseUrl}services/${groupId}`, { method:'POST', headers:{'Content-Type':'application/json'} });
            if(!r.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —É—Å–ª—É–≥');
            const data = await r.json(); servicesCache.set(groupId, data); return data;
        }catch(e){ screen().innerHTML = pageError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —É—Å–ª—É–≥.'); console.error(e); return []; }
    }

    function renderServices(services, groupId){
        const items = Array.isArray(services)? services : (services?.items||[]);
        if(!items.length){ screen().innerHTML = emptyState('–í —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ –Ω–µ—Ç —É—Å–ª—É–≥','–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –≥—Ä—É–ø–ø—É.'); return; }
        const grid=document.createElement('div'); grid.className='grid gap-4 grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4';
        items.forEach(s=>{
            const sid=getServiceId(s), title=getServiceTitle(s), provider=getProviderName(s);
            const card=document.createElement('article'); card.className='rounded-lg border border-slate-200 dark:border-slate-800 p-4 pr-9 pt-7 hover:shadow-soft hover:translate-y-[-1px] transition bg-white dark:bg-slate-900 animate-in';
            card.innerHTML=`<h3 class="font-semibold leading-tight text-brand break-anywhere">${escapeHTML(title)}</h3>
                      ${provider? `<p class="mt-1 text-xs text-slate-500 break-anywhere">${escapeHTML(provider)}</p>`:''}
                      <div class="mt-4"><button class="w-full rounded-lg bg-brand text-white px-3 py-2 hover:bg-brand-600 active:bg-brand-700 transition">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button></div>`;
            card.onclick=()=>{ updateHash({ view:'service', service: sid, group: groupId }); haptic('impact'); };
            grid.appendChild(card);
        });
        screen().innerHTML=''; screen().appendChild(grid);
    }

    // Service screen
    async function showServiceScreen(serviceId){
        setBackVisible(true);
        setTitle('–£—Å–ª—É–≥–∞');

        // –°–±—Ä–æ—Å–∏—Ç—å ¬´–ù–∞–∑–∞–¥¬ª –∫ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é (–∫ –ø–æ–∏—Å–∫—É, –µ—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –∏–∑ –Ω–µ–≥–æ)
        const backBtn = document.getElementById('navBack');
        if (backBtn) backBtn.onclick = () => history.back();
        try {
            tg?.BackButton?.show();
            tg?.BackButton?.onClick(() => history.back());
        } catch {}

        screen().innerHTML = pageLoading('–ó–∞–≥—Ä—É–∑–∫–∞ —É—Å–ª—É–≥–∏.');
        let service = serviceDetailsCache.get(serviceId);
        if(!service){
            try{
                const r=await fetch(`${apiBaseUrl}service_details/${serviceId}`, { method:'POST', headers:{'Content-Type':'application/json'} });
                if(!r.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                service=await r.json();
                serviceDetailsCache.set(serviceId, service);
            } catch(e){
                screen().innerHTML = pageError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏.');
                console.error(e);
                return;
            }
        }
        renderServiceDetails(service);
        fetchFeedbacks(serviceId); // –æ—Ç–¥–µ–ª—å–Ω–æ–π –ø–æ—Ä—Ü–∏–µ–π
    }

    function renderServiceDetails(service){
        const parts=[]; const title=getServiceTitle(service);
        parts.push(`<h2 class="text-2xl font-bold text-brand mb-2 break-anywhere">${escapeHTML(title)}</h2>`);
        if (service.shortDescription) {
            const sd = String(service.shortDescription).trim();
            const title = getServiceTitle(service).trim();
            if (sd && sd.toLowerCase() !== title.toLowerCase()) {
                parts.push(
                    `<div class="rounded-lg bg-gradient-to-r from-[var(--sd-from)] to-[var(--sd-to)] text-[var(--sd-fg)] px-4 py-3 mb-4">
        ${escapeHTML(sd)}
      </div>`
                );
            }
        }

        if(service.service){ parts.push(`<div class="mb-4"><p class="font-medium mb-1">üé≤ –û–ø–∏—Å–∞–Ω–∏–µ:</p><div class="prose prose-sm dark:prose-invert max-w-none whitespace-pre-wrap break-anywhere">${linkify(service.service)}</div></div>`); }
        parts.push(`<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <div><p class="font-medium">üë§ –ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</p><div class="text-slate-700 dark:text-slate-300 whitespace-pre-wrap break-anywhere">${escapeHTML(service.contactPerson||'–ù–µ —É–∫–∞–∑–∞–Ω–æ')}</div></div>
      <div><p class="font-medium">üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã</p><div class="text-slate-700 dark:text-slate-300 whitespace-pre-wrap break-anywhere">${formatPhoneNumbers((service.contacts||'').replace(/\n/g,'\n'))}</div></div>
    </div>`);
        if(service.links || service.url){ const block=[service.links,service.url].filter(Boolean).join('\n'); parts.push(`<div class="mt-3"><p class="font-medium">üîó –°—Å—ã–ª–∫–∏</p><div class="text-sm text-brand-700 dark:text-brand-400 whitespace-pre-wrap break-anywhere">${linkify(block)}</div></div>`); }
        parts.push(`<div id="feedbacks-container" class="mt-6"></div>`);
        screen().innerHTML = `<div class="space-y-2 animate-in">${parts.join('')}</div>`;
    }
    async function fetchFeedbacks(serviceId){
        const container=document.getElementById('feedbacks-container'); if(!container) return; container.innerHTML = inlineSpinner('–ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–∑—ã–≤—ã...');
        let feedbacks;
        try{
            if(feedbacksCache.has(serviceId)) feedbacks=feedbacksCache.get(serviceId);
            else { const r=await fetch(apiBaseUrl+'getFeedbacks/'+encodeURIComponent(serviceId), { method:'POST', headers:{'Content-Type':'application/json'} }); if(!r.ok) throw new Error('Bad response'); feedbacks=await r.json(); feedbacksCache.set(serviceId, feedbacks); }
            if(feedbacks.message){ container.innerHTML = `<div class="rounded-lg border border-slate-200 dark:border-slate-800 p-4 text-sm">${escapeHTML(feedbacks.message)}</div>`; }
            else{
                const avg = calculateAverageRating(feedbacks);
                const list=document.createElement('div'); list.className='space-y-3';
                const header=`<div class=\"mb-2 text-sm\"><span class=\"font-medium\">–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: ${avg}‚≠êÔ∏è</span></div>`;
                feedbacks.forEach(f=>{
                    const item=document.createElement('div'); item.className='rounded-lg border border-slate-200 dark:border-slate-800 p-3 animate-in';
                    item.innerHTML=`<div class="flex items-center justify-between text-sm"><strong>${escapeHTML(f.usersName||'–ê–Ω–æ–Ω–∏–º')}</strong><span class="text-slate-500">–û—Ü–µ–Ω–∫–∞: ${escapeHTML(String(f.feedbackRating||'‚Äî'))}</span></div>
                           <p class="mt-2 text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap break-anywhere">${escapeHTML(f.feedbackText||'')}</p>`;
                    list.appendChild(item);
                });
                container.innerHTML = header; container.appendChild(list);
            }
        }catch(e){ container.innerHTML = pageError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç–∑—ã–≤—ã.'); console.error(e); }
    }

    // Search screen (full-screen)
    function showSearchScreen(q){
        setBackVisible(true);
        setTitle('–ü–æ–∏—Å–∫');

        const view=document.createElement('div');
        view.className='space-y-3';
        view.innerHTML = `
      <div class="sticky top-14 pt-2 bg-white/90 dark:bg-slate-900/90 backdrop-blur z-10">
        <div class="relative">
          <input id="searchInput" type="text" inputmode="search" autocomplete="off" spellcheck="false" placeholder="–ù–∞–π—Ç–∏ —É—Å–ª—É–≥—É..." class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white/70 dark:bg-slate-800 pl-11 pr-12 py-3 focus:outline-none focus:ring-2 focus:ring-brand text-base shadow transition" />
          <span class="absolute left-3 top-3.5 text-slate-400">üîé</span>
          <button id="clearSearchBtn" class="absolute right-3 top-2.5 text-slate-400 hover:text-slate-600 text-xl leading-none px-2" aria-label="–û—á–∏—Å—Ç–∏—Ç—å">&times;</button>
        </div>
      </div>
      <div id="searchState" class="text-center text-slate-500 py-6">–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞</div>
      <div id="results" class="space-y-2"></div>`;
        screen().innerHTML='';
        screen().appendChild(view);

        const input=view.querySelector('#searchInput');
        const clear=view.querySelector('#clearSearchBtn');
        const state=view.querySelector('#searchState');
        const results=view.querySelector('#results');

        input.value = q || '';
        input.oninput = debounce(() => {
            const v = input.value.trim();
            const p = new URLSearchParams(location.hash.slice(1));
            p.set('view','search');        // –æ—Å—Ç–∞—ë–º—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ –ø–æ–∏—Å–∫–∞
            if (v) p.set('q', v); else p.delete('q');
            history.replaceState(null, '', '#'+p.toString()); // <-- –Ω–µ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
            doSearch(v, state, results);
        }, 220);

        clear.onclick = ()=> {
            input.value='';
            updateHash({ q:'' }, true);
            results.innerHTML='';
            state.textContent='–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞';
            input.focus();
        };

        if(q) doSearch(q, state, results); else input.focus();

        // === –≤–æ—Ç —Å—é–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º ===
        function exitSearchToRoot(){
            history.replaceState(null, '', location.pathname + location.search);
            showGroupsScreen(); // –∏–ª–∏ routeFromHash();
        }
        navBack.onclick = exitSearchToRoot;
        if (tg?.BackButton){
            tg.BackButton.onClick(exitSearchToRoot);
        }
    }

    function openSearchScreen(){
        const p = new URLSearchParams(location.hash.slice(1));
        p.set('view','search');
        p.delete('q');                 // —á–∏—Å—Ç—ã–π —Å—Ç–∞—Ä—Ç –ø–æ–∏—Å–∫–∞
        location.hash = '#'+p.toString(); // <-- –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏–∏
    }

    let searchAbort=null;
    function doSearch(query, stateEl, listEl){
        if(!query){ listEl.innerHTML=''; stateEl.textContent='–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞'; return; }
        stateEl.innerHTML = inlineSpinner('–ò—â–µ–º...'); listEl.innerHTML='';
        if(searchAbort) searchAbort.abort(); searchAbort = new AbortController();
        stateEl.classList.remove('hidden');
        stateEl.innerHTML = inlineSpinner('–ò—â–µ–º...');
        listEl.innerHTML = '';
        fetch(`${apiBaseUrl}search_services?query=${encodeURIComponent(query)}`, { signal: searchAbort.signal })
            .then(r=>r.json())
            .then(items=> renderSearchResults(items||[], stateEl, listEl))
            .catch(()=> { stateEl.textContent='–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞'; });
    }

    function renderSearchResults(results, stateEl, listEl) {
        const items = Array.isArray(results) ? results : [];

        // 1) –ü—É—Å—Ç–∞—è –≤—ã–¥–∞—á–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
        if (!items.length) {
            stateEl.classList.remove('hidden');          // –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
            stateEl.textContent = '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
            listEl.innerHTML = '';
            return;
        }

        // 2) –ï—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ —Ä–∏—Å—É–µ–º —Å–ø–∏—Å–æ–∫
        stateEl.classList.add('hidden');
        listEl.innerHTML = '';

        const frag = document.createDocumentFragment();

        items.forEach((item) => {
            const sid   = item.servicesID ?? item.serviceId ?? item.id;
            const gid   = item.groupId ?? item.groupID ?? item.GroupID;
            const title = item.text || item.serviceName || '–£—Å–ª—É–≥–∞';
            const prov  = item.providerName || '';
            const gname = item.groupName || '';

            const row = document.createElement('button');
            row.type = 'button';
            row.className = 'w-full text-left rounded-xl border border-slate-200 dark:border-slate-800 p-3 hover:bg-slate-50 dark:hover:bg-slate-800 transition';
            row.innerHTML = `
      <div class="font-semibold text-brand text-base leading-tight break-anywhere">${escapeHTML(title)}</div>
      <div class="text-slate-600 dark:text-slate-400 text-sm mt-0.5 break-anywhere">${escapeHTML(prov)}</div>
      <div class="text-slate-400 text-xs mt-0.5 break-anywhere">${escapeHTML(gname)}</div>
    `;

            // –ö–ª–∏–∫ –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É: –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –¥–µ—Ç–∞–ª–∏ —É—Å–ª—É–≥–∏, –°–û–•–†–ê–ù–Ø–Ø —à–∞–≥ ¬´–ø–æ–∏—Å–∫¬ª –≤ –∏—Å—Ç–æ—Ä–∏–∏
            row.onclick = () => {
                const p = new URLSearchParams(location.hash.slice(1));
                p.set('view', 'service');
                if (sid != null) p.set('service', sid);
                if (gid != null) p.set('group', gid);
                p.delete('q'); // —Å–∞–º —ç–∫—Ä–∞–Ω —É—Å–ª—É–≥–∏ q –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç

                // –í–ê–ñ–ù–û: –ø—É—à–∏–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å (location.hash), –∞ –ù–ï replaceState:
                // —Ç–∞–∫ ¬´–ù–∞–∑–∞–¥¬ª –≤–µ—Ä–Ω—ë—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —Ö—ç—à—É ‚Äî —ç–∫—Ä–∞–Ω—É –ø–æ–∏—Å–∫–∞ —Å —Ç–µ–º –∂–µ q.
                location.hash = '#' + p.toString();
            };

            frag.appendChild(row);
        });

        listEl.appendChild(frag);
    }


    function debounce(fn, ms=200){
        let t; return function(...args){
            clearTimeout(t);
            t = setTimeout(()=>fn.apply(this,args), ms);
        };
    }


    function pageLoading(msg){ return `<div class="flex flex-col items-center justify-center py-16 gap-3"><div class="w-10 h-10 border-2 border-slate-300 dark:border-slate-700 border-t-brand rounded-full animate-spin"></div><p class="text-sm text-slate-500">${escapeHTML(msg)}</p></div>`; }
    function pageError(msg){ return `<div class="rounded-lg border border-red-200 dark:border-red-900/40 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-200 p-4">${escapeHTML(msg)}</div>`; }
    function emptyState(title, sub){ return `<div class="rounded-xl border border-dashed border-slate-300 dark:border-slate-700 p-10 text-center"><div class="text-3xl mb-2">üôÇ</div><div class="font-medium mb-1">${escapeHTML(title)}</div><div class="text-sm text-slate-500">${escapeHTML(sub||'')}</div></div>`; }
    function inlineSpinner(msg){ return `<div class="flex items-center justify-center gap-2 text-sm text-slate-500 py-2"><div class="w-5 h-5 border-2 border-slate-300 dark:border-slate-700 border-t-brand rounded-full animate-spin"></div><span>${escapeHTML(msg)}</span></div>`; }

    function escapeHTML(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#039;'); }
    function getGroupId(g){ return g.groupId ?? g.GroupID ?? g.id ?? g.ID ?? g.groupID ?? String(g.name || g.title || Math.random().toString(36).slice(2)); }
    function getGroupName(g){ return g.groupName ?? g.GroupName ?? g.name ?? g.title ?? '–ì—Ä—É–ø–ø–∞'; }
    function getServiceId(s){ return s.servicesID ?? s.serviceId ?? s.id ?? s.ID ?? s.ServiceID ?? s.ServicesID ?? Math.random().toString(36).slice(2); }
    function getServiceTitle(s){ return s.shortDescription ?? s.serviceName ?? s.title ?? '–£—Å–ª—É–≥–∞'; }
    function getProviderName(s){ return s.providerName ?? s.provider ?? s.ownerName ?? s.contactPerson ?? ''; }
    function formatPhoneNumbers(text){ const lines=String(text||'').split('\n'); return lines.map(l=>{ const t=l.trim(); const num=t.replace(/[^\d+]/g,''); if(num.length>=7){ return `<a class=\"underline underline-offset-2\" href=\"tel:${escapeHTML(num)}\">${escapeHTML(t)}</a>`;} return escapeHTML(t); }).join('<br>'); }
    function linkify(text){ const esc=escapeHTML(String(text||'')); const urlRe=/\b((?:https?:\/\/|ftp:\/\/)[^\s<>"']+|www\.[^\s<>"']+)/gi; return esc.replace(urlRe,(m)=>{ const href=m.startsWith('http')||m.startsWith('ftp')? m : ('https://'+m); return `<a class=\"underline underline-offset-2 break-anywhere\" href=\"${href}\" target=\"_blank\" rel=\"noopener noreferrer\">${m}</a>`; }); }
    function calculateAverageRating(list){ if(!Array.isArray(list)||list.length===0) return 0; const nums=list.map(x=>Number(x.feedbackRating)).filter(n=>Number.isFinite(n)); if(nums.length===0) return 0; const avg=nums.reduce((a,b)=>a+b,0)/nums.length; return Math.round(avg*10)/10; }
</script>
</body>
</html>
