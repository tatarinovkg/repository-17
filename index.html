<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All services</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f7f7f8;
            color: #333;
            min-height: 100vh;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }

        #content {
            width: 100%;
            max-width: 100%;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        h1, h2 {
            margin: 10px 0;
            text-align: center;
        }

        .group, .service, .back-button {
            background: #ffffff;
            padding: 15px;
            width: 100%;
            max-width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
            font-size: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            word-wrap: break-word;
        }

        .group:hover, .service:hover, .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgb(200, 200, 200);
            background-color: #f3f3f3;
        }

        .loading {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            height: 100vh;
            color: #555;
            font-size: 18px;
            background-color: rgba(255, 255, 255, 0.7);
        }

        .spinner {
            margin-bottom: 15px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info {
            background: white;
            padding: 15px;
            width: 100%;
            max-width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .info h3 {
            margin: 0;
            font-size: 18px;
        }

        .info p {
            margin: 0;
            font-size: 16px;
        }

        .back-button {
            background-color: #298ee6;
            color: white;
            width: 100%;
            max-width: 100%;
            padding: 15px; /* –î–æ–±–∞–≤–ª—è–µ–º padding */
            box-sizing: border-box; /* –£—á–∏—Ç—ã–≤–∞–µ–º padding –≤ —Ä–∞–∑–º–µ—Ä–∞—Ö */
            border-radius: 12px; /* –°–æ–≤–ø–∞–¥–∞–µ—Ç —Å –±–ª–æ–∫–∞–º–∏ */
            border: none;
            cursor: pointer;
            text-align: center;
            font-size: 16px;
            display: flex; /* –î–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è */
            justify-content: center;
            align-items: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }

        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(200, 200, 200);
            background-color: #267bc3;
        }
        .feedback {
            background-color: #ffffff;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;  /* –ß—Ç–æ–±—ã padding —É—á–∏—Ç—ã–≤–∞–ª—Å—è –≤ —Ä–∞–∑–º–µ—Ä–∞—Ö */
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            margin-bottom: 8px;
            flex-wrap: wrap; /* –î–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç–∞–º –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å—Å—è */
        }

        .rating {
            font-weight: bold;
            color: #298ee6;
            margin-left: 10px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –∏–º–µ–Ω–∏ */
        }

        .feedback-text {
            font-size: 14px;
            color: #555;
            margin-top: 5px;
            word-wrap: break-word; /* –î–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –¥–ª–∏–Ω–Ω—ã—Ö —Å–ª–æ–≤ */
            word-break: break-word; /* –î–ª—è –∂–µ—Å—Ç–∫–æ–≥–æ –ø–µ—Ä–µ–Ω–æ—Å–∞ –≤ —Å–ª—É—á–∞–µ –¥–ª–∏–Ω–Ω—ã—Ö —Å–ª–æ–≤ */
        }

        .service-name, .user-name, .contact-info {
            white-space: pre-wrap;
        }

        .service-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 8px;
        }

        .user-name {
            font-size: 18px;
        }

        #searchInput {
            transition: border 0.3s cubic-bezier(0.4,0,0.2,1), box-shadow 0.3s cubic-bezier(0.4,0,0.2,1);
            border: 2px solid #e0e0e0;
            outline: none;
            border-radius: 12px;
            background: #fff;
            font-size: 16px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(41,142,230,0.06);
        }

        #searchInput:focus {
            border: 2px solid #298ee6;
            box-shadow: 0 0 0 4px rgba(41,142,230,0.12);
            background: #fafdff;
        }

        /* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–¥—Å–∫–∞–∑–æ–∫: —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –≤—Å—ë –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
        #suggestions {
            display: flex;
            flex-direction: column;
            align-items: center;    /* –∫–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç */
            gap: 12px;
            margin-top: 20px;
            width: 100%;
        }
        /* —Å–∞–º–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–¥—Å–∫–∞–∑–æ–∫ */
        .service {
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
<div id="content">
    <div class="loading">
        <div class="spinner"></div>
        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ, –∑–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>
    <button id="searchButton" class="back-button">üîç –ü–æ–∏—Å–∫ —É—Å–ª—É–≥</button>
</div>
<script>
    const tg = window.Telegram.WebApp;
    const apiBaseUrl = 'http://94.103.12.161/api/';
    tg.expand();
    tg.MainButton.text = "–ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ";
    tg.MainButton.onClick(() => tg.close());
    tg.MainButton.show();

    let currentGroupId = null;
    let groupsCache = null;
    let servicesCache = new Map();
    let serviceDetailsCache = new Map();
    let searchTimeout;
    let lastSearchQuery = "";

    async function fetchGroups() {
        if (groupsCache) {
            showGroups(groupsCache);
            return;
        }

        const content = document.getElementById('content');
        content.innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ, –∑–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>`;

        try {
            const response = await fetch(`${apiBaseUrl}groups`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const groups = await response.json();
            groupsCache = groups; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥—Ä—É–ø–ø—ã –≤ –∫—ç—à–µ
            showGroups(groups);
        } catch (error) {
            showError("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≥—Ä—É–ø–ø");
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –≥—Ä—É–ø–ø:", error);
        }
    }

    function showGroups(groups) {
        const content = document.getElementById('content');
        // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —à–∞–ø–∫—É —Å –∫–Ω–æ–ø–∫–æ–π
        content.innerHTML = `
      <button id="searchButton" class="back-button">
        üîç –ü–æ–∏—Å–∫ —É—Å–ª—É–≥
      </button>
      <h2>–í—Å–µ –≥—Ä—É–ø–ø—ã —Å —É—Å–ª—É–≥–∞–º–∏</h2>
    `;
        // –¢–µ–ø–µ—Ä—å ‚Äì —Å–∞–º–∏ –≥—Ä—É–ø–ø—ã
        groups.forEach(group => {
            const div = document.createElement('div');
            div.className = 'group';
            div.innerText = group.name;
            div.onclick = () => {
                currentGroupId = group.groupID;
                fetchServices(group.groupID);
            };
            content.appendChild(div);
        });
        // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É (–µ—â—ë —Ä–∞–∑, —Ç.–∫. –ø–µ—Ä–µ—Å–æ–∑–¥–∞–ª–∏ –µ—ë)
        document.getElementById('searchButton').onclick = showSearchField;
    }


    async function fetchServices(groupId) {
        if (servicesCache.has(groupId)) {
            showServices(servicesCache.get(groupId));
            return;
        }

        currentGroupId = groupId;

        const content = document.getElementById('content');
        content.innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ, –∑–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>`;

        try {
            const response = await fetch(`${apiBaseUrl}services/${groupId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const services = await response.json();
            servicesCache.set(groupId, services); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —É—Å–ª—É–≥–∏ –≤ –∫—ç—à–µ
            showServices(services);
        } catch (error) {
            showError("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —É—Å–ª—É–≥");
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —É—Å–ª—É–≥:", error);
        }
    }

    function showServices(services) {
        const content = document.getElementById('content');
        content.innerHTML = '<h2>–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</h2>';
        services.forEach(service => {
            const serviceDiv = document.createElement('div');
            serviceDiv.classList.add('service');
            // –í—ã–≤–æ–¥–∏–º –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ
            serviceDiv.innerText = service.shortDescription + '\n' + service.contactPerson;
            serviceDiv.onclick = () => {
                if (service.servicesID) {
                    fetchServiceDetails(service.servicesID, true, false); // true‚Äì–Ω–∞–∑–∞–¥ –∫ —É—Å–ª—É–≥–∞–º, false‚Äì–Ω–µ –∏–∑ –ø–æ–∏—Å–∫–∞
                } else {
                    console.error("servicesID –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ undefined:", service);
                }
            };
            content.appendChild(serviceDiv);
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫ —Å ID –≥—Ä—É–ø–ø—ã –≤–Ω–∏–∑—É —Å–ø–∏—Å–∫–∞ —É—Å–ª—É–≥
        const groupIdDiv = document.createElement('div');
        groupIdDiv.style.fontSize = '14px';
        groupIdDiv.style.color = '#888';
        groupIdDiv.style.marginTop = '10px';
        groupIdDiv.innerText = 'ID –≥—Ä—É–ø–ø—ã: ' + currentGroupId;
        content.appendChild(groupIdDiv);

        const backButton = document.createElement('button');
        backButton.classList.add('back-button');
        backButton.innerText = '–ù–∞–∑–∞–¥ –∫ –≥—Ä—É–ø–ø–∞–º';
        backButton.onclick = fetchGroups;
        content.appendChild(backButton);
    }



    async function fetchServiceDetails(serviceId, showBackButton = false, fromSearch = false) {
        if (serviceDetailsCache.has(serviceId)) {
            showServiceDetails(serviceDetailsCache.get(serviceId), showBackButton, fromSearch);
            fetchFeedbacks(serviceId);
            return;
        }

        const content = document.getElementById('content');
        content.innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ, –∑–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>`;

        try {
            const response = await fetch(`${apiBaseUrl}service_details/${serviceId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
            const service = await response.json();
            if (service.error) throw new Error(service.error);
            serviceDetailsCache.set(serviceId, service); // –ö—ç—à–∏—Ä—É–µ–º
            showServiceDetails(service, showBackButton, fromSearch);
            fetchFeedbacks(serviceId);
        } catch (error) {
            showError("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —É—Å–ª—É–≥–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL.");
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏:", error);
        }
    }

    async function fetchFeedbacks(serviceId) {
        const content = document.getElementById('content');

        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤
        let feedbacksContainer = document.getElementById('feedbacks-container');

        if (!feedbacksContainer) {
            feedbacksContainer = document.createElement('div');
            feedbacksContainer.id = 'feedbacks-container';
            content.appendChild(feedbacksContainer);
        } else {
            // –û—á–∏—Å—Ç–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –µ—Å—Ç—å
            feedbacksContainer.innerHTML = '';
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –±–ª–æ–∫–µ —Å –æ—Ç–∑—ã–≤–∞–º–∏
        feedbacksContainer.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –æ—Ç–∑—ã–≤—ã...</p>
        </div>
    `;

        try {
            const response = await fetch(`${apiBaseUrl}getFeedbacks/${serviceId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            if (response.ok) {
                const feedbacks = await response.json();
                feedbacksContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º

                if (feedbacks.message) {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    feedbacksContainer.innerHTML = `<h3>${feedbacks.message}</h3>`;
                } else {
                    // –ï—Å–ª–∏ –æ—Ç–∑—ã–≤—ã –µ—Å—Ç—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –∏ —Å–∞–º–∏ –æ—Ç–∑—ã–≤—ã
                    const averageRating = calculateAverageRating(feedbacks);
                    feedbacksContainer.innerHTML = `
                    <h2>–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: ${averageRating}‚≠êÔ∏è</h2>
                `;

                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—Ç–∑—ã–≤—ã
                    showFeedbacks(feedbacksContainer, feedbacks);
                }
            } else {
                feedbacksContainer.innerHTML = `<h2>–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–∑—ã–≤–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</h2>`;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–∑—ã–≤–æ–≤:', error);
            feedbacksContainer.innerHTML = `<h2>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ç–∑—ã–≤–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</h2>`;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–∑—ã–≤–æ–≤
    function showFeedbacks(feedbacksContainer, feedbacks) {
        feedbacks.forEach(feedback => {
            const feedbackDiv = document.createElement('div');
            feedbackDiv.classList.add('feedback');

            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –∏–º—è, —Ä–µ–π—Ç–∏–Ω–≥ –∏ —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞
            feedbackDiv.innerHTML = `
            <div class="feedback-header">
                <strong>${feedback.usersName}</strong>
                <span class="rating">–û—Ü–µ–Ω–∫–∞: ${feedback.feedbackRating}</span>
            </div>
            <p class="feedback-text">${feedback.feedbackText}</p>
        `;
            feedbacksContainer.appendChild(feedbackDiv);
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞
    function calculateAverageRating(feedbacks) {
        const totalRating = feedbacks.reduce((sum, feedback) => sum + feedback.feedbackRating, 0);
        return (totalRating / feedbacks.length).toFixed(1);
    }

    function showServiceDetails(service, showBackButton, fromSearch) {
        const content = document.getElementById('content');
        content.innerHTML = `
        <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å–ª—É–≥–µ</h2>
        <div class="info">
            <h3 class="service-name">üõ† ${service.shortDescription || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</h3>
            ${service.service ? `
                <div>
                    <p><strong>üé≤ –û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏:</strong></p>
                    <div style="white-space: pre-wrap; text-align: left;">${service.service}</div>
                </div>` : ""}
            <div>
                <p><strong>üë§ –ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ:</strong></p>
                <div style="white-space: pre-wrap; text-align: left;">${service.contactPerson || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
            </div>
            <div>
                <p><strong>üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã:</strong></p>
                <div style="white-space: pre-wrap; text-align: left;">${service.contacts ? formatPhoneNumbers(service.contacts.replace(/\n/g, '<br>')) : '–ù–µ —É–∫–∞–∑–∞–Ω—ã'}</div>
            </div>
            <div style="font-size: 14px; color: #888; margin-top: 8px;">ID —É—Å–ª—É–≥–∏: ${service.servicesID}</div>
        </div>
    `;

        // –î–æ–±–∞–≤–ª—è—Ç—å –∫–Ω–æ–ø–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–æ, —á—Ç–æ –æ–Ω–∞ –Ω—É–∂–Ω–∞
        if (fromSearch) {
            const backButton = document.createElement('button');
            backButton.classList.add('back-button');
            backButton.innerText = '–ù–∞–∑–∞–¥ –∫ –ø–æ–∏—Å–∫—É';
            backButton.onclick = showSearchField;
            content.appendChild(backButton);
        } else if (showBackButton) {
            const backButton = document.createElement('button');
            backButton.classList.add('back-button');
            backButton.innerText = '–ù–∞–∑–∞–¥ –∫ —É—Å–ª—É–≥–∞–º';
            backButton.onclick = () => fetchServices(currentGroupId);
            content.appendChild(backButton);
        }
    }

    function showSearchField() {
        const content = document.getElementById('content');
        content.innerHTML = `
        <h2>–ü–æ–∏—Å–∫ —É—Å–ª—É–≥</h2>
        <input id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å..." value="${lastSearchQuery}" style="padding: 12px; width: 100%; max-width: 100%; border-radius: 12px; border: 1px solid #ccc; font-size: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.3s ease;" autofocus />
        <div id="suggestions" style="margin-top: 20px; width: 100%; display: flex; flex-direction: column; gap: 12px;"></div>
        <button class="back-button" onclick="fetchGroups()">–ù–∞–∑–∞–¥</button>
    `;

        const input = document.getElementById('searchInput');
        if (lastSearchQuery) fetchSuggestions(lastSearchQuery);

        input.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                input.blur();
            }
        });

        input.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            const q = input.value.trim();
            lastSearchQuery = q; // ‚Üê —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
            if (!q || /^\d+$/.test(q)) {
                document.getElementById('suggestions').innerHTML = '';
                return;
            }
            searchTimeout = setTimeout(() => fetchSuggestions(q), 250);
        });
    }


    async function fetchSuggestions(query) {
        try {
            const res = await fetch(`${apiBaseUrl}search_services?query=${encodeURIComponent(query)}`);
            const results = await res.json();
            const suggestionsDiv = document.getElementById('suggestions');

            suggestionsDiv.innerHTML = results.length
                ? results.map(item => `
            <div class="service" onclick="fetchServiceDetails(${item.servicesID}, false, true)">
              ${item.text}
            </div>
          `).join('')
                : `<div class="service">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>`;
        } catch (e) {
            console.error('Search error:', e);
        }
    }


    function showError(message) {
        const content = document.getElementById('content');
        content.innerHTML = `
        <div class="error" style="text-align: center; margin-top: 20px;">
            <h2>${message}</h2>
        </div>
    `;
    }

    function showGroupsFromServices() {
        fetchGroups();
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ serviceId –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    const serviceId = urlParams.get('serviceId');
    // –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä –µ—Å—Ç—å, –∑–∞–≥—Ä—É–∂–∞–µ–º —É—Å–ª—É–≥—É, –∏–Ω–∞—á–µ ‚Äî –≥—Ä—É–ø–ø—ã
    if (serviceId) {
        const parsedId = parseInt(serviceId, 10);
        if (!isNaN(parsedId)) {
            fetchServiceDetails(parsedId, false, false); // –æ–±–∞ false ‚Äî –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞
        } else {
            showError("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π serviceId –≤ URL.");
        }
    } else {
        fetchGroups();
    }

    function formatPhoneNumbers(text) {
        // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
        const phoneRegex = /(?:\+?\d{1,4}[-.\s]?)?(?:\(?\d{1,4}\)?[-.\s]?)?(?:\d{1,4}[-.\s]?){1,4}/g;

        return text.replace(phoneRegex, (match) => {
            // –£–¥–∞–ª–∏–º –≤—Å–µ –Ω–µ—á–∏—Å–ª–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
            const phoneNumber = match.replace(/[^\d+]/g, '').trim();
            return `<a href="tel:${phoneNumber}">${match.trim()}</a>`;
        });
    }
</script>
</body>
</html>
